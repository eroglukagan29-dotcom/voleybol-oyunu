<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Duck Hunt: SÃ¼lo Verison</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: #fff; font-family: sans-serif; text-align: center; overflow: hidden; }
        .box { background: #333; padding: 20px; border-radius: 15px; display: inline-block; margin-top: 50px; border: 2px solid #39ff14; }
        button { background: #39ff14; color: #000; border: none; padding: 15px 25px; font-weight: bold; border-radius: 10px; cursor: pointer; margin: 10px; }
        input { background: #000; color: #39ff14; border: 1px solid #39ff14; padding: 10px; width: 100px; text-align: center; font-size: 20px; }
        canvas { display: none; background: #4ec0ff; width: 100vw; height: 100vh; }
        #fireBtn { display: none; position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); width: 150px; height: 150px; border-radius: 50%; background: red; border: 5px solid white; color: white; font-size: 24px; }
        #status { color: #ffcc00; margin-top: 10px; font-size: 14px; }
    </style>
</head>
<body>

<div id="ui" class="box">
    <h2>DUCK HUNT CONNECT</h2>
    <div id="role-select">
        <button onclick="start('screen')">ðŸ“º EKRAN</button>
        <button onclick="start('gun')">ðŸ”« SÄ°LAH</button>
    </div>

    <div id="display-area" style="display:none">
        <p id="info-text">Kodunuz:</p>
        <h1 id="id-show" style="letter-spacing: 5px; color: #39ff14;">----</h1>
        <div id="qrcode" style="background: white; padding: 5px; display: inline-block;"></div>
        <div id="gun-input" style="display:none">
            <br><input type="text" id="target-id" placeholder="KOD">
            <button onclick="connect()">BAÄžLAN</button>
        </div>
        <div id="status">Sistem bekleniyor...</div>
    </div>
</div>

<canvas id="game"></canvas>
<button id="fireBtn">ATEÅž</button>

<script>
let peer, conn, role;
const status = document.getElementById('status');

function start(r) {
    role = r;
    document.getElementById('role-select').style.display = 'none';
    document.getElementById('display-area').style.display = 'block';
    
    // PeerJS sunucusuna baÄŸlan (GÃ¼venli ID oluÅŸturma)
    peer = new Peer('DH-' + Math.floor(1000 + Math.random() * 9000));

    peer.on('open', (id) => {
        const shortId = id.replace('DH-', '');
        document.getElementById('id-show').innerText = shortId;
        status.innerText = "BaÄŸlantÄ± hazÄ±r, karÅŸÄ± tarafÄ± bekle.";
        
        if(role === 'screen') {
            new QRCode(document.getElementById("qrcode"), {
                text: window.location.href.split('?')[0] + "?join=" + shortId,
                width: 120, height: 120
            });
        } else {
            document.getElementById('gun-input').style.display = 'block';
            document.getElementById('qrcode').style.display = 'none';
            document.getElementById('info-text').innerText = "Kendi kodun (gerekirse):";
        }
    });

    // Ekran tarafÄ±: Gelen baÄŸlantÄ±yÄ± yakala
    peer.on('connection', (c) => {
        conn = c;
        status.innerText = "BaÄŸlanÄ±yor...";
        setupConn();
    });

    peer.on('error', (err) => {
        console.error(err);
        status.innerText = "Hata: " + err.type;
    });
}

// Silah tarafÄ±: Ekrana baÄŸlan
function connect() {
    const target = "DH-" + document.getElementById('target-id').value.toUpperCase();
    status.innerText = "BaÄŸlantÄ± isteÄŸi gÃ¶nderildi...";
    conn = peer.connect(target, { reliable: true });
    setupConn();
}

function setupConn() {
    conn.on('open', () => {
        status.innerText = "BAÄžLANDI!";
        setTimeout(() => {
            document.getElementById('ui').style.display = 'none';
            if(role === 'screen') initGame();
            else initGun();
        }, 1000);
    });

    conn.on('data', (data) => {
        if(data === 'BANG') {
            window.flashScreen();
        }
    });

    conn.on('close', () => {
        alert("BaÄŸlantÄ± koptu!");
        location.reload();
    });
}

// Oyun ve Silah Ä°ÅŸlevleri
function initGame() {
    const cvs = document.getElementById('game');
    const ctx = cvs.getContext('2d');
    cvs.style.display = 'block';
    cvs.width = window.innerWidth; cvs.height = window.innerHeight;
    
    let x = 100, y = 100, dx = 5, dy = 3, flash = false;
    window.flashScreen = () => { flash = true; setTimeout(() => flash = false, 50); };

    function draw() {
        ctx.fillStyle = flash ? "white" : "#4ec0ff";
        ctx.fillRect(0, 0, cvs.width, cvs.height);
        if(!flash) {
            x += dx; y += dy;
            if(x<0 || x>cvs.width) dx *= -1;
            if(y<0 || y>cvs.height*0.7) dy *= -1;
            ctx.fillStyle = "yellow";
            ctx.beginPath(); ctx.arc(x, y, 30, 0, 7); ctx.fill();
        }
        requestAnimationFrame(draw);
    }
    draw();
}

function initGun() {
    document.getElementById('fireBtn').style.display = 'block';
    document.getElementById('fireBtn').onclick = () => {
        if(conn && conn.open) conn.send('BANG');
    };
}

// URL'den otomatik doldurma (QR iÃ§in)
const urlParams = new URLSearchParams(window.location.search);
if(urlParams.has('join')) {
    setTimeout(() => {
        start('gun');
        setTimeout(() => {
            document.getElementById('target-id').value = urlParams.get('join');
            connect();
        }, 1500);
    }, 500);
}
</script>
</body>
</html>

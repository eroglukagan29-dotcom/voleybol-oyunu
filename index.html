<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Duck Hunt: Hybrid Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root { --retro-blue: #64b5f6; --retro-green: #2e7d32; --duck-yellow: #ffcc00; --nes-red: #ff4444; }
        body { margin: 0; background: #000; font-family: 'Press Start 2P', cursive; overflow: hidden; color: white; }
        
        /* MENÜ TASARIMI */
        #setup { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; z-index: 1000; }
        .btn-group { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        button { padding: 20px; font-family: 'Press Start 2P'; font-size: 0.8rem; border: 4px solid #fff; cursor: pointer; transition: 0.2s; background: #333; color: white; }
        button:hover { background: var(--duck-yellow); color: black; transform: scale(1.05); }
        .hidden { display: none !important; }
        .ready-status { margin-top: 10px; font-size: 0.6rem; color: #0f0; }

        /* OYUN ALANI */
        #game-container { position: relative; width: 100vw; height: 100vh; background: var(--retro-blue); display: none; }
        #grass { position: absolute; bottom: 0; width: 100%; height: 20%; background: var(--retro-green); z-index: 10; border-top: 6px solid #1b5e20; }
        
        /* ÖRDEK */
        #duck-target { position: absolute; width: 80px; height: 80px; z-index: 5; }
        .hitbox { position: absolute; width: 60px; height: 60px; background: white; display: none; z-index: 100; top: 10px; left: 10px; }
        
        /* MOBİL KONTROLLER */
        .mobile-ui { display: none; position: fixed; width: 100vw; height: 100vh; background: #222; z-index: 2000; text-align: center; }
        #joystick-container { width: 200px; height: 200px; background: #444; border-radius: 50%; margin: 50px auto; position: relative; border: 5px solid #666; }
        #joystick-knob { width: 80px; height: 80px; background: var(--duck-yellow); border-radius: 50%; position: absolute; top: 60px; left: 60px; }
        .vak-btn { background: #fff; color: #000; padding: 30px; border-radius: 15px; font-weight: bold; margin-top: 20px; display: inline-block; }

        .flash-active { background: black !important; }
        .flash-active * { visibility: hidden !important; }
        .flash-active .hitbox { visibility: visible !important; display: block !important; }
    </style>
</head>
<body>

<div id="setup">
    <h1 id="menu-title">DUCK HUNT</h1>
    
    <div id="main-menu" class="btn-group">
        <button onclick="showSubMenu(1)">1 PLAYER</button>
        <button onclick="showSubMenu(2)">2 PLAYER</button>
    </div>

    <div id="sub-menu" class="btn-group hidden">
        <button id="btn-host" onclick="init('screen')">SCREEN (PC)</button>
        <button id="btn-p1" onclick="init('gun')">PLAYER 1 (GUN)</button>
        <button id="btn-p2" class="hidden" onclick="init('duck')">PLAYER 2 (DUCK)</button>
        <button id="btn-ready" class="hidden" onclick="sendReady()" style="border-color: #0f0;">READY!</button>
        <button onclick="location.reload()" style="font-size: 0.5rem;">BACK</button>
    </div>

    <div id="conn-info" style="margin-top:20px; font-size: 0.7rem;"></div>
</div>

<div id="game-container">
    <div style="position:absolute; top:20px; left:20px; font-size:1rem; z-index:100;">SCORE: <span id="score-val">0</span></div>
    <div id="duck-target">
        <div class="hitbox"></div>
        <svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="#556b2f" /></svg>
    </div>
    <div id="grass"></div>
</div>

<div id="duck-ui" class="mobile-ui">
    <div id="joystick-container">
        <div id="joystick-knob"></div>
    </div>
    <div class="vak-btn" onclick="vakla()">VAKLA!</div>
</div>

<div id="gun-ui" class="mobile-ui">
    <video id="gun-cam" autoplay playsinline style="width:100%; height:100%; object-fit:cover; opacity:0.3;"></video>
    <div onclick="handleFire()" style="position:absolute; bottom:10%; left:50%; transform:translateX(-50%); padding:40px; background:red; border-radius:50%; border:5px solid white;">FIRE</div>
</div>

<script>
let peer, conns = [], role, mode = 1, score = 0;
let readyCount = 0;
let duckPos = { x: 0.5, y: 0.5 };
let isP2Active = false;

function showSubMenu(m) {
    mode = m;
    document.getElementById('main-menu').classList.add('hidden');
    document.getElementById('sub-menu').classList.remove('hidden');
    if(m === 2) document.getElementById('btn-p2').classList.remove('hidden');
}

function init(r) {
    role = r;
    const id = 'DH-' + Math.floor(1000 + Math.random() * 9000);
    peer = new Peer(id);
    peer.on('open', () => {
        document.getElementById('conn-info').innerText = "CODE: " + id.replace('DH-','');
        if(role !== 'screen') {
            let target = prompt("Enter PC Code:");
            if(target) setupConnection(peer.connect('DH-' + target.toUpperCase()));
            document.getElementById('btn-ready').classList.remove('hidden');
        }
    });
    peer.on('connection', c => setupConnection(c));
}

function setupConnection(c) {
    conns.push(c);
    c.on('data', data => {
        if(data.type === 'READY') {
            readyCount++;
            if(readyCount >= mode) startGame();
        }
        if(data.type === 'DUCK_MOVE') { 
            duckPos = { x: data.x, y: data.y }; 
            isP2Active = true; 
        }
        if(data.type === 'VAK') new Audio('vak.wav').play().catch(()=>console.log("Ses dosyası yok!"));
        if(data.type === 'FIRE_REQ') triggerFlash();
        if(data.type === 'HIT') handleHit();
    });
}

function sendReady() {
    conns[0].send({type: 'READY'});
    document.getElementById('btn-ready').innerText = "WAITING...";
}

function startGame() {
    document.getElementById('setup').style.display = 'none';
    if(role === 'screen') {
        document.getElementById('game-container').style.display = 'block';
        gameLoop();
    } else if(role === 'duck') {
        document.getElementById('duck-ui').style.display = 'block';
        initJoystick();
    } else if(role === 'gun') {
        document.getElementById('gun-ui').style.display = 'block';
        startCamera();
    }
}

// KLAVYE KONTROLÜ (WASD OTOMATİK KATILIM)
window.addEventListener('keydown', (e) => {
    if(role === 'screen' && ['w','a','s','d'].includes(e.key.toLowerCase())) {
        isP2Active = true; // WASD basıldığı an Player 2 (Klavye) devralır
        const speed = 0.02;
        if(e.key === 'w') duckPos.y -= speed;
        if(e.key === 's') duckPos.y += speed;
        if(e.key === 'a') duckPos.x -= speed;
        if(e.key === 'd') duckPos.x += speed;
    }
});

// JOYSTICK MANTIĞI
function initJoystick() {
    const knob = document.getElementById('joystick-knob');
    document.getElementById('joystick-container').ontouchmove = (e) => {
        const touch = e.touches[0];
        const rect = e.target.getBoundingClientRect();
        let x = (touch.clientX - rect.left) / rect.width;
        let y = (touch.clientY - rect.top) / rect.height;
        conns[0].send({type: 'DUCK_MOVE', x, y});
        knob.style.left = (x * 120) + 'px';
        knob.style.top = (y * 120) + 'px';
    };
}

function vakla() { conns[0].send({type: 'VAK'}); }

function gameLoop() {
    const duck = document.getElementById('duck-target');
    let autoX = 0, autoY = 0, angle = 0;

    function update() {
        if(!isP2Active) {
            // Otomatik Hareket
            angle += 0.02;
            autoX = (Math.cos(angle) * 0.3) + 0.5;
            autoY = (Math.sin(angle * 0.5) * 0.2) + 0.4;
            duck.style.left = (autoX * window.innerWidth) + 'px';
            duck.style.top = (autoY * window.innerHeight) + 'px';
        } else {
            // Player 2 veya WASD Kontrolü
            duck.style.left = (duckPos.x * window.innerWidth) + 'px';
            duck.style.top = (duckPos.y * window.innerHeight) + 'px';
        }
        requestAnimationFrame(update);
    }
    update();
}

// Flash ve Hit fonksiyonlarını önceki sürümlerdeki gibi ekle...
function triggerFlash() {
    const gc = document.getElementById('game-container');
    gc.classList.add('flash-active');
    setTimeout(() => gc.classList.remove('flash-active'), 100);
}
function handleHit() { 
    score += 100; document.getElementById('score-val').innerText = score;
    document.getElementById('duck-target').style.display = 'none';
    setTimeout(()=> { document.getElementById('duck-target').style.display = 'block'; }, 1000);
}
</script>
</body>
</html>

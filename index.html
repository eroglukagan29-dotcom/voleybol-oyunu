
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Duck Hunt: Pro Hunter</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: #fff; font-family: 'Courier New', Courier, monospace; text-align: center; overflow: hidden; }
        .box { background: #222; padding: 20px; border-radius: 15px; display: inline-block; margin-top: 50px; border: 3px solid #ffcc00; }
        button { background: #ffcc00; color: #000; border: none; padding: 15px 25px; font-weight: bold; border-radius: 10px; cursor: pointer; margin: 10px; }
        canvas { display: none; background: #4ec0ff; width: 100vw; height: 100vh; }
        #fireBtn { display: none; position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); width: 160px; height: 160px; border-radius: 50%; background: #cc0000; border: 8px solid #fff; color: white; font-size: 24px; font-weight: bold; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        #fireBtn:active { transform: translateX(-50%) scale(0.95); background: #ff0000; }
        #score-board { position: fixed; top: 10px; left: 10px; font-size: 24px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px; color: #39ff14; display: none; }
        #video-hidden { display: none; }
    </style>
</head>
<body>

<div id="ui" class="box">
    <h2 style="color:#ffcc00">DUCK HUNT PRO</h2>
    <div id="role-select">
        <button onclick="start('screen')">ðŸ“º EKRAN (PC)</button>
        <button onclick="start('gun')">ðŸ”« SÄ°LAH (TELEFON)</button>
    </div>
    <div id="display-area" style="display:none">
        <h1 id="id-show" style="letter-spacing: 5px; color: #39ff14;">----</h1>
        <div id="qrcode" style="background: white; padding: 5px; display: inline-block;"></div>
        <div id="gun-input" style="display:none">
            <input type="text" id="target-id" placeholder="KOD" style="font-size:20px; width:100px; padding:10px; text-align:center">
            <button onclick="connect()">BAÄžLAN</button>
        </div>
        <p id="status">HazÄ±rlanÄ±yor...</p>
    </div>
</div>

<div id="score-board">SCORE: 0</div>
<canvas id="game"></canvas>
<video id="video-hidden" autoplay playsinline></video>
<button id="fireBtn">ATEÅž!</button>

<script>
let peer, conn, role;
let score = 0;
const status = document.getElementById('status');
const video = document.getElementById('video-hidden');

function start(r) {
    role = r;
    document.getElementById('role-select').style.display = 'none';
    document.getElementById('display-area').style.display = 'block';
    
    peer = new Peer('DH-' + Math.floor(1000 + Math.random() * 9000));

    peer.on('open', (id) => {
        const shortId = id.replace('DH-', '');
        document.getElementById('id-show').innerText = shortId;
        if(role === 'screen') {
            new QRCode(document.getElementById("qrcode"), { text: window.location.href.split('?')[0] + "?join=" + shortId, width: 120, height: 120 });
        } else {
            document.getElementById('gun-input').style.display = 'block';
            document.getElementById('qrcode').style.display = 'none';
            // Silah tarafÄ±nda kamerayÄ± hazÄ±rla
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => video.srcObject = s);
        }
    });

    peer.on('connection', (c) => { conn = c; setupConn(); });
}

function connect() {
    conn = peer.connect("DH-" + document.getElementById('target-id').value.toUpperCase(), { reliable: true });
    setupConn();
}

function setupConn() {
    conn.on('open', () => {
        document.getElementById('ui').style.display = 'none';
        if(role === 'screen') {
            document.getElementById('score-board').style.display = 'block';
            initGame();
        } else {
            document.getElementById('fireBtn').style.display = 'block';
        }
    });

    conn.on('data', (data) => {
        if(data === 'SHOT_REQ') window.flashScreen();
        if(data === 'HIT' && role === 'screen') window.registerHit();
    });
}

// OYUN MOTORU (EKRAN TARAFINI BU ÅžEKÄ°LDE GÃœNCELLE)
function initGame() {
    const cvs = document.getElementById('game');
    const ctx = cvs.getContext('2d');
    cvs.style.display = 'block';
    cvs.width = window.innerWidth; 
    cvs.height = window.innerHeight;
    
    // Ã–rdek baÅŸlangÄ±Ã§ deÄŸerleri
    let duck = { 
        x: cvs.width / 2, 
        y: cvs.height - 100, 
        dx: 4, 
        dy: -4, 
        r: 35, 
        hit: false, 
        falling: false 
    };
    
    let flash = false;

    window.flashScreen = () => { 
        flash = true; 
        setTimeout(() => flash = false, 70); 
    };

    window.registerHit = () => {
        if (duck.hit) return; // Zaten vurulmuÅŸsa tekrar vurulmasÄ±n
        duck.hit = true;
        score += 100;
        document.getElementById('score-board').innerText = "SCORE: " + score;
        
        // Vurulunca kÄ±sa bir duraksama, sonra dÃ¼ÅŸÃ¼ÅŸ
        duck.dx = 0;
        duck.dy = 0;
        
        setTimeout(() => {
            duck.falling = true;
            duck.dy = 10; // HÄ±zlÄ±ca dÃ¼ÅŸ
        }, 300);
    };

    function resetDuck() {
        duck.x = Math.random() * (cvs.width - 100) + 50;
        duck.y = cvs.height - 50;
        duck.hit = false;
        duck.falling = false;
        // Puan arttÄ±kÃ§a hÄ±zlanan dinamik hÄ±z
        let speed = 4 + (score / 1000);
        duck.dx = (Math.random() > 0.5 ? speed : -speed);
        duck.dy = -speed;
    }

    function draw() {
        // Arka plan rengi (Vurulma anÄ±nda beyaz, normalde gÃ¶kyÃ¼zÃ¼)
        ctx.fillStyle = flash ? "white" : "#4ec0ff";
        ctx.fillRect(0, 0, cvs.width, cvs.height);

        if (!flash) {
            // Ã–rdek Hareketi
            duck.x += duck.dx;
            duck.y += duck.dy;

            // Ekran sÄ±nÄ±rlarÄ±ndan sekme (VurulmamÄ±ÅŸsa)
            if (!duck.hit) {
                if (duck.x < 0 || duck.x > cvs.width) duck.dx *= -1;
                if (duck.y < 0) duck.dy *= -1;
                // Ã–rdek Ã§ok aÅŸaÄŸÄ± inerse (kaÃ§arsa) resetle
                if (duck.y > cvs.height) resetDuck();
            }

            // Ã–rdek yere dÃ¼ÅŸtÃ¼yse resetle
            if (duck.falling && duck.y > cvs.height) {
                resetDuck();
            }

            // GÃ¶rselleÅŸtirme
            ctx.save();
            ctx.translate(duck.x, duck.y);
            
            if (duck.hit && !duck.falling) {
                // Vurulma anÄ± (ÅŸaÅŸkÄ±n Ã¶rdek)
                ctx.fillStyle = "red";
                ctx.fillRect(-20, -20, 40, 40);
                ctx.fillStyle = "white";
                ctx.fillText("X X", -10, 5);
            } else {
                // Normal Ã¶rdek veya dÃ¼ÅŸen Ã¶rdek
                ctx.fillStyle = duck.falling ? "#8B4513" : "yellow";
                ctx.beginPath();
                ctx.arc(0, 0, duck.r, 0, Math.PI * 2);
                ctx.fill();
                // Gaga
                ctx.fillStyle = "orange";
                ctx.fillRect(20, -5, 15, 10);
            }
            ctx.restore();
        }
        requestAnimationFrame(draw);
    }
    resetDuck(); // Oyunu baÅŸlat
    draw();
}
// SÄ°LAH KONTROLÃœ (TELEFON)
document.getElementById('fireBtn').onclick = () => {
    if(!conn || !conn.open) return;
    conn.send('SHOT_REQ'); // EkranÄ± parlat

    // Parlama anÄ±nda kamerayÄ± analiz et
    setTimeout(() => {
        const tempCvs = document.createElement('canvas');
        tempCvs.width = video.videoWidth;
        tempCvs.height = video.videoHeight;
        const tCtx = tempCvs.getContext('2d');
        tCtx.drawImage(video, 0, 0);
        
        const pixels = tCtx.getImageData(0,0, tempCvs.width, tempCvs.height).data;
        let bright = 0;
        for(let i=0; i<pixels.length; i+=20) { // Performans iÃ§in her piksele bakma
            if(pixels[i] > 220 && pixels[i+1] > 220 && pixels[i+2] > 220) bright++;
        }

        if(bright > 30) { // EÄŸer yeterince beyazlÄ±k gÃ¶rdÃ¼yse
            conn.send('HIT');
            if(navigator.vibrate) navigator.vibrate(200);
        }
    }, 30);
};
</script>
</body>
</html>

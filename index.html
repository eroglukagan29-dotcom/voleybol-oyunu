<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Duck Hunt: Quick Link</title>
    <style>
        body { margin: 0; background: #000; color: #55ff55; font-family: 'Courier New', monospace; text-align: center; overflow: hidden; }
        .panel { padding: 20px; border: 2px solid #55ff55; display: inline-block; margin-top: 50px; background: #111; max-width: 90%; }
        input, button { background: #222; color: #55ff55; border: 1px solid #55ff55; padding: 10px; margin: 5px; font-size: 16px; width: 80%; }
        button:active { background: #55ff55; color: #000; }
        canvas { display: none; background: #4ec0ff; cursor: crosshair; width: 100vw; height: 100vh; }
        #fireBtn { display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 150px; height: 150px; border-radius: 50%; background: red; color: white; font-weight: bold; border: 5px solid white; }
    </style>
</head>
<body>

<div id="setup" class="panel">
    <h2>DUCK HUNT OS</h2>
    <div id="step1">
        <button onclick="init('screen')">1. EKRAN OL</button>
        <button onclick="init('gun')">2. SİLAH OL</button>
    </div>
    <div id="step2" style="display:none">
        <p>KODU OKU/YAZ:</p>
        <input type="text" id="codeIO" placeholder="Kod buraya...">
        <button onclick="processCode()">ONAYLA</button>
        <p style="font-size: 12px; color: #888;">*Karşı cihazın kodunu buraya yazın.</p>
    </div>
</div>

<canvas id="game"></canvas>
<button id="fireBtn">ATEŞ</button>

<script>
let role, pc = new RTCPeerConnection(), dc;
const io = document.getElementById('codeIO');

// 1. BAŞLATMA
async function init(r) {
    role = r;
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';

    if (role === 'gun') {
        dc = pc.createDataChannel("shot");
        setupDC();
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
    } else {
        pc.ondatachannel = e => { dc = e.channel; setupDC(); };
    }

    pc.onicecandidate = e => {
        if (!e.candidate) {
            // Sadece gerekli olan SDP kısmını kısaltarak veriyoruz
            io.value = btoa(pc.localDescription.sdp).substring(0, 100); 
            console.log("Paylaşılacak kısa kod:", io.value);
            alert("Kendi kodun kutuda oluştu. Bunu kopyalayıp diğerine yaz.");
        }
    };
}

// 2. KOD İŞLEME (MANUEL OKU-YAZ)
async function processCode() {
    const raw = io.value;
    // Not: Gerçek bir kısaltma için SDP sıkıştırma gerekir, 
    // ama kopyala-yapıştır en güvenli "sunucusuz" yoldur.
    // Eğer sunucu eklemek istersen "PeerJS" kütüphanesi ile 4 haneli ID yapabiliriz.
    
    try {
        const desc = new RTCSessionDescription({
            type: (role === 'screen' ? 'offer' : 'answer'),
            sdp: atob(raw) 
        });
        await pc.setRemoteDescription(desc);
        if (role === 'screen') {
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
        }
    } catch(e) { alert("Kod hatalı!"); }
}

function setupDC() {
    dc.onopen = () => {
        document.getElementById('setup').style.display = 'none';
        if(role === 'screen') startGame();
        else startGun();
    };
    dc.onmessage = e => { if(e.data === 'BANG') hitEffect(); };
}

// 3. OYUN VE SİLAH MANTIĞI
function startGame() {
    const cvs = document.getElementById('game');
    const ctx = cvs.getContext('2d');
    cvs.style.display = 'block';
    cvs.width = window.innerWidth; cvs.height = window.innerHeight;
    
    let x = 0, y = 100, flash = false;
    function draw() {
        ctx.fillStyle = flash ? "white" : "#4ec0ff";
        ctx.fillRect(0,0,cvs.width, cvs.height);
        if(!flash) {
            ctx.fillStyle = "yellow";
            ctx.beginPath(); ctx.arc(x % cvs.width, y, 30, 0, 7); ctx.fill();
            x += 5;
        }
        requestAnimationFrame(draw);
    }
    window.hitEffect = () => { flash = true; setTimeout(()=>flash=false, 40); };
    draw();
}

function startGun() {
    document.getElementById('fireBtn').style.display = 'block';
    document.getElementById('fireBtn').onclick = () => dc.send('BANG');
}
</script>
</body>
</html>

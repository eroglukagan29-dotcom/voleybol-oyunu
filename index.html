<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Duck Hunt: Retro Tech Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --retro-blue: #64b5f6; --retro-green: #2e7d32; }
        body { margin: 0; background: #000; font-family: 'Courier New', monospace; overflow: hidden; color: white; }
        
        /* OYUN ALANI */
        #game-container { position: relative; width: 100vw; height: 100vh; background: var(--retro-blue); display: none; }
        #grass { position: absolute; bottom: 0; width: 100%; height: 20%; background: var(--retro-green); z-index: 10; border-top: 4px solid #1b5e20; }
        
        /* Ã–RDEK VE HÄ°TBOX (BEYAZ KUTU) */
        #duck-target { position: absolute; width: 80px; height: 80px; z-index: 5; }
        .hitbox { position: absolute; width: 60px; height: 60px; background: white; display: none; z-index: 100; top: 10px; left: 10px; }
        
        /* SÄ°LAH ARAYÃœZÃœ (TELEFON) */
        #gun-ui { display: none; position: fixed; width: 100vw; height: 100vh; text-align: center; }
        #video-preview { width: 100%; height: 100%; object-fit: cover; opacity: 0.3; }
        #fire-trigger { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); width: 150px; height: 150px; border-radius: 50%; background: red; border: 10px solid white; font-weight: bold; font-size: 1.5rem; color: white; z-index: 10; }

        /* SKOR VE MESAJLAR */
        #ui-layer { position: absolute; top: 20px; width: 100%; text-align: center; font-size: 2rem; z-index: 200; pointer-events: none; }
        #setup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #222; padding: 30px; border: 4px solid #fff; z-index: 1000; }
        
        /* KARARMA EFEKTÄ° */
        .flash-dark { background: black !important; }
        .flash-dark * { visibility: hidden !important; }
        .flash-dark .hitbox { visibility: visible !important; display: block !important; }
    </style>
</head>
<body>

<div id="setup">
    <h1>DUCK HUNT</h1>
    <button onclick="init('screen')" style="padding: 20px; background: #ffcc00; font-weight: bold;">ðŸ“º EKRAN OL</button>
    <button onclick="init('gun')" style="padding: 20px; background: #ffcc00; font-weight: bold;">ðŸ”« SÄ°LAH OL</button>
    <h2 id="conn-code"></h2>
</div>

<div id="game-container">
    <div id="ui-layer">SCORE: <span id="score">0</span></div>
    <div id="duck-target">
        <div class="hitbox"></div>
        <svg viewBox="0 0 100 100" id="duck-svg">
            <ellipse cx="50" cy="50" rx="35" ry="25" fill="#556b2f" />
            <circle cx="70" cy="35" r="15" fill="#556b2f" />
            <path d="M85 35 L 95 30 L 95 40 Z" fill="#ffa500" />
            <rect x="20" y="40" width="30" height="5" fill="white" />
        </svg>
    </div>
    <div id="grass"></div>
</div>

<div id="gun-ui">
    <video id="video-preview" autoplay playsinline></video>
    <canvas id="capture-canvas" style="display:none;"></canvas>
    <button id="fire-trigger">ATEÅž!</button>
</div>

<script>
let peer, conn, role, score = 0;
const container = document.getElementById('game-container');
const duck = document.getElementById('duck-target');
const video = document.getElementById('video-preview');
const canvas = document.getElementById('capture-canvas');

async function init(r) {
    role = r;
    const id = 'DH-' + Math.floor(1000 + Math.random() * 9000);
    peer = new Peer(id);
    
    peer.on('open', () => {
        document.getElementById('conn-code').innerText = "KOD: " + id.replace('DH-','');
        if(role === 'gun') {
            startCamera();
            let t = prompt("Ekrandaki kodu gir:");
            if(t) { conn = peer.connect('DH-' + t.toUpperCase()); setupConn(); }
        }
    });
    peer.on('connection', c => { conn = c; setupConn(); });
}

async function startCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
    video.srcObject = stream;
}

function setupConn() {
    conn.on('open', () => {
        document.getElementById('setup').style.display = 'none';
        if(role === 'screen') {
            container.style.display = 'block';
            runGameLoop();
        } else {
            document.getElementById('gun-ui').style.display = 'block';
            document.getElementById('fire-trigger').onclick = handleFire;
        }
    });
    
    conn.on('data', data => {
        if(data === 'REQ_FLASH') triggerFlash();
        if(data === 'HIT') processHit();
    });
}

// --- SÄ°LAH (TELEFON) MANTIÄžI ---
function handleFire() {
    // 1. Ekrana "karar ve beyaz kutuyu aÃ§" sinyali gÃ¶nder
    conn.send('REQ_FLASH');
    
    // 2. Ã‡ok kÄ±sa bir sÃ¼re bekle (EkranÄ±n kararmasÄ± iÃ§in)
    setTimeout(() => {
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        
        // 3. Merkeze bak (NiÅŸan alÄ±nan yer)
        const pixelData = ctx.getImageData(canvas.width/2, canvas.height/2, 1, 1).data;
        const brightness = (pixelData[0] + pixelData[1] + pixelData[2]) / 3;
        
        // 4. EÄŸer parlaklÄ±k yÃ¼ksekse (Beyaz kutuyu gÃ¶rdÃ¼yse) vurduk!
        if(brightness > 200) {
            conn.send('HIT');
        }
    }, 100); // 100ms gecikme
}

// --- EKRAN (PC) MANTIÄžI ---
function triggerFlash() {
    container.classList.add('flash-dark');
    setTimeout(() => container.classList.remove('flash-dark'), 150); 
}

function processHit() {
    score += 100;
    document.getElementById('score').innerText = score;
    duck.style.display = 'none';
    setTimeout(() => {
        duck.style.display = 'block';
        resetDuckPosition();
    }, 1000);
}

function resetDuckPosition() {
    window.duckX = Math.random() * (window.innerWidth - 100);
    window.duckY = window.innerHeight;
}

function runGameLoop() {
    window.duckX = 100; window.duckY = 100;
    let dx = 5, dy = 3;
    
    function update() {
        if(duck.style.display !== 'none') {
            window.duckX += dx; window.duckY += dy;
            if(window.duckX < 0 || window.duckX > window.innerWidth - 80) dx *= -1;
            if(window.duckY < 0 || window.duckY > window.innerHeight * 0.7) dy *= -1;
            
            duck.style.left = window.duckX + 'px';
            duck.style.top = window.duckY + 'px';
            duck.style.transform = `scaleX(${dx > 0 ? 1 : -1})`;
        }
        requestAnimationFrame(update);
    }
    update();
}
</script>
</body>
</html>

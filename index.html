<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Web Duck Hunt</title>
<style>
body{margin:0;background:#111;color:white;font-family:sans-serif;text-align:center}
button{font-size:22px;margin:10px;padding:10px 20px}
canvas{background:#4ec0ff;display:none}
#video{display:none}
textarea{width:90%;height:80px}
</style>
</head>
<body>

<h1>Duck Hunt Web</h1>
<div id="menu">
  <button onclick="start('screen')">Ekran (TV/PC)</button>
  <button onclick="start('gun')">Silah (Telefon)</button>
</div>

<div id="connect" style="display:none">
  <p>Bu kodu karşı cihaza yapıştır:</p>
  <textarea id="offer"></textarea><br>
  <button onclick="copyOffer()">Kopyala</button>
  <p>Karşıdan gelen kodu buraya yapıştır:</p>
  <textarea id="answer"></textarea><br>
  <button onclick="setAnswer()">Bağlan</button>
</div>

<canvas id="game"></canvas>
<video id="video" autoplay playsinline width="300"></video>
<br>
<button id="fireBtn" style="display:none" onclick="fire()">ATEŞ</button>

<script>
let role, pc, dc;
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const video = document.getElementById("video");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let duck = {x:300,y:200,r:40};
let flash=false;

function start(r){
  role=r;
  document.getElementById("menu").style.display="none";
  document.getElementById("connect").style.display="block";

  pc = new RTCPeerConnection();
  dc = pc.createDataChannel("data");

  dc.onmessage = (e)=>{
    if(e.data==="FIRE" && role==="screen"){
      flashWhite();
    }
  };

  pc.onicecandidate = e=>{
    if(!e.candidate){
      document.getElementById("offer").value =
        btoa(JSON.stringify(pc.localDescription));
    }
  };

  if(role==="screen"){
    draw();
  }

  if(role==="gun"){
    navigator.mediaDevices.getUserMedia({video:true})
      .then(s=>video.srcObject=s);
    video.style.display="block";
    document.getElementById("fireBtn").style.display="inline";
  }

  pc.createOffer().then(o=>pc.setLocalDescription(o));
}

function copyOffer(){
  navigator.clipboard.writeText(
    document.getElementById("offer").value);
}

function setAnswer(){
  const ans = JSON.parse(atob(
    document.getElementById("answer").value));
  pc.setRemoteDescription(ans);
}

function flashWhite(){
  flash=true;
  setTimeout(()=>flash=false,30);
}

function draw(){
  ctx.fillStyle = flash ? "black" : "#4ec0ff";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle = flash ? "white" : "yellow";
  ctx.beginPath();
  ctx.arc(duck.x, duck.y, duck.r, 0, Math.PI*2);
  ctx.fill();

  requestAnimationFrame(draw);
}

function fire(){
  dc.send("FIRE");
  setTimeout(checkHit,50);
}

function checkHit(){
  const c=document.createElement("canvas");
  const x=c.getContext("2d");
  c.width=video.videoWidth;
  c.height=video.videoHeight;
  x.drawImage(video,0,0);

  const d=x.getImageData(0,0,c.width,c.height).data;
  let bright=0;
  for(let i=0;i<d.length;i+=4){
    if(d[i]>240 && d[i+1]>240 && d[i+2]>240) bright++;
  }

  alert(bright>50 ? "VURDUN!" : "KAÇTI!");
}
</script>
</body>
</html>
